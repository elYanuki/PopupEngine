class PopupEngine{
	static modal = document.createElement("div")
	static modalContent = document.createElement("div")
	static initialized = false
	static config = {
		doLogs: true,
	}

	static endModal 

	static init(config){
		if(this.initialized == true){
			if(this.config.doLogs)
			console.log("PopupEngine is already initialized, will ignore this call.")
			return
		}

		//configure the engine
		if(config){
			if(config.doLogs != undefined)
			this.config.doLogs = config.doLogs

		}

		//create needed html
		this.modal.classList.add("popupEngineModalContainer")
		this.modal.style.display = "none"

		this.modalContent.classList.add("popupEngineModalContent")

		this.modal.appendChild(this.modalContent)

		if (document.readyState === 'complete' || document.readyState === 'interactive') {
			document.body.appendChild(document.createComment('Code generated by popupEngine'))
			document.body.appendChild(this.modal)

			this.createCSS()

			this.initialized = true
		} 
		else {
			console.log("onload")
			
			window.addEventListener('load', ()=>{
				document.body.appendChild(document.createComment('Code generated by popupEngine'))
				document.body.appendChild(this.modal)

				this.createCSS()

				this.initialized = true
			});
		}
	}

	static createCSS(){
		//create stylesheet
		const style = document.createElement('style')
		document.head.appendChild(style)

		const stylesheet = style.sheet

		stylesheet.insertRule(`.popupEngineModalContainer{
			position: fixed;
			inset: 0;
			background-color: var(--popupEngine-blur-color);
			z-index: 1000;
			display: none;
			place-content: center;
			font-family: sans-serif;
			color: var(--popupEngine-color);
			transition: opacity .3s;
			opacity:0;
			backdrop-filter: blur(4px);

			--popupEngine-blur-color: rgba(0, 0, 0, 0.5);
			--popupEngine-background-color: white;
			--popupEngine-color: black;
		}`)

		stylesheet.insertRule(`.popupEngineModalContent { 
			background-color: var(--popupEngine-background-color);
			padding: 2vw 5vw;
			max-width: 90vw;
			min-width: 25vw;
			overflow: hidden;
			word-wrap: break-word;
			transition: scale .3s;
			transition-timing-function: cubic-bezier(.13,.68,.46,1.33);
			scale: 0; 
		}`)

		stylesheet.insertRule(`.popupEngineModalHeading {
			text-align: center;
			font-size: 1.5rem
		}`)

		stylesheet.insertRule(`.popupEngineModalText {
			text-align: center;
			margin-bottom: 1rem;
		}`)
	}

	static createPopup(settings = {}){
		return new Promise((resolve, reject) => {
			this.endModal = resolve
	
			//#region checks
			
			if (document.readyState === 'loading') {
				if(this.config.doLogs)
				console.error("PopupEngine cant be run before DOM content has finished loading. Try adding a window.load() event arround this call.")
				return
			} 
	
			if(!this.initialized){
				if(this.config.doLogs)
				console.error("PopupEngine has not yet been initialized: PopupEngine.init(). \n if this error keeps occuring try running PopupEngine.test()")
				return
			}
	
			if(this.modal.style.display != "none"){
				if(this.config.doLogs)
				console.log('overwriting old popup: "' + this.modalContent.querySelector(".popupEngineModalText").innerHTML + '"')
			}

			//#endregion
			
			//#region generate content

			this.modalContent.innerHTML = ""

			//create heading
			if(settings.heading){
				let heading = document.createElement("p")
				heading.innerHTML = settings.heading
				heading.classList.add("popupEngineModalHeading")

				this.modalContent.appendChild(heading)
			}

			//generate text
			let popupText = document.createElement("p")
			popupText.classList.add("popupEngineModalText")
			popupText.innerHTML = settings.text || "no text specified"
	
			this.modalContent.appendChild(popupText)

			//create input
			if(!settings.inputs || settings.inputs.length == 0){
				settings.inputs = []
			}

			let popupInputs = document.createElement("div")
			popupInputs.classList.add("popupEngineModalInputs")
			popupInputs.style.cssText = `
				display: flex;
				flex-direction: column;
				justify-content: center;`

			for (let i = 0; i < settings.inputs.length; i++) {
				let input = document.createElement("input")

				if(settings.inputs[i].label){
					input.name = i

					let label = document.createElement("label")
					label.classList.add("popupEngineModalInputLabel")
					label.style.cssText = `
					font-size: .9rem;`
					label.innerText = settings.inputs[i].label

					popupInputs.appendChild(label)
				}

				input.style.cssText = `
					padding: .5rem;
					border: 1px solid gray;
					margin: .2rem 0 .5rem 0;
					color: var(--popupEngine-color);`
				input.type = settings.inputs[i].type || "text"
				input.placeholder = settings.inputs[i].placeholder || ""
				input.classList.add("popupEngineModalInput")
	
				popupInputs.appendChild(input)
			}
	
			this.modalContent.appendChild(popupInputs)
			
			//create buttons
			if(!settings.buttons || settings.buttons.length == 0){
				settings.buttons = [{text: "okay"}]
			}
	
			let popupButtons = document.createElement("div")
			popupButtons.classList.add("popupEngineModalButtons")
			popupButtons.style.cssText = `
				display: flex;
				flex-wrap: wrap;
				gap: 1rem;
				justify-content: center;`

			for (let i = 0; i < settings.buttons.length; i++) {
				let button = document.createElement("button")
				button.style.cssText = `
					cursor: pointer;
					border: 1px solid gray;
					padding: .5rem;
					color: var(--popupEngine-color);`
				button.innerText = settings.buttons[i].text
				button.onclick = function () { 
					PopupEngine.closePopup(
						settings.buttons[i].closePopup, 
						settings.buttons[i].action, 
						{
							text: settings.text,
							heading: settings.heading,
							buttons: settings.buttons,
							inputs: settings.inputs,
							buttonIndex: i,
						}
				)}
				button.classList.add("popupEngineModalButton")
	
				popupButtons.appendChild(button)
			}
	
			this.modalContent.appendChild(popupButtons)
	
			//#endregion
	
			//show popup
			this.modal.style.display = "grid"
			setTimeout(function(){
				document.querySelector('.popupEngineModalContainer').style.opacity = 1
				document.querySelector('.popupEngineModalContent').style.scale = 1
			},0)
		})
	}

	static closePopup(closePopup = true, closeAction, data){
		//get values of inputs
		if(this.modalContent.querySelector(".popupEngineModalInputs")){
			let inputValues = []
			document.querySelectorAll('.popupEngineModalInputs .popupEngineModalInput').forEach(item => {
				inputValues.push(item.value)
			})
			data.inputValues = inputValues
		}

		if(closeAction){
			closeAction(data)
		}

		if(closePopup){
			this.modal.style.display = "none"
			this.modal.style.opacity = 0
			this.modalContent.style.scale = 0

			this.endModal(data)
		}
	}

	/**
	 * test method, creates one popup and outputs errors
	 */
	static test(){
		if(!this.initialized){
			console.error("TEST: PopupEngine has not yet been initialized: PopupEngine.init()")
			return
		}
		if(!document.querySelector('.popupEngineModalContainer')){
			console.error("TEST: Could not find DOM elements needed to run PopupEngine. This is probably because the Engine has not yet been initialized: PopupEngine.init()")
			return
		}
		if(!document.querySelector('.popupEngineModalContent')){
			console.error("TEST: Could not find DOM elements needed to run PopupEngine. This might be a problem with the initialization but is probably because another script has changed the engines elements or because your version of the engine is faulty.")
			return
		}
		console.log("TEST: all DOOM elements seem fine");
		console.log(
		`TEST: Generating popup from following code:
		PopupEngine.createPopup({
			text: "test",
			buttons: [
				{
					text: "okay",
					action: () => {console.log("okay")}
				}
			]
		}`);
		PopupEngine.createPopup({
			text: "test",
			buttons: [
				{
					text: "okay",
					action: () => {console.log("okay")}
				}
			]
		})
	}
}